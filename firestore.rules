rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    // Helper function - checks if user exists in admins collection
    function isAdmin() {
      return request.auth != null &&
             exists(/databases/$(database)/documents/admins/$(request.auth.uid));
    }

    // Admins collection: only admins can read, no one can write (manual setup only)
    match /admins/{adminId} {
      allow read: if request.auth != null && request.auth.uid == adminId;
      allow write: if false; // Manually managed in Firebase Console
    }

    // Products: public read, admin write
    match /products/{productId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // Site content: public read, admin write
    match /siteContent/{contentId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // Honeypot logs: anyone creates (with size limit), admin reads and deletes
    match /honeypot_logs/{logId} {
      allow create: if request.resource.data.keys().hasAll(['email', 'timestamp'])
                    && request.resource.data.email is string
                    && request.resource.data.email.size() <= 100;
      allow read, delete: if isAdmin();
      allow update: if false;
    }

    // Easter eggs: public read, admin write
    match /easterEggs/{eggId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // Messages: validated create, admin manages
    match /messages/{messageId} {
      allow create: if request.resource.data.keys().hasAll(['name', 'email', 'message'])
                    && request.resource.data.name is string
                    && request.resource.data.name.size() > 0
                    && request.resource.data.name.size() <= 100
                    && request.resource.data.email is string
                    && request.resource.data.email.size() <= 100
                    && request.resource.data.message is string
                    && request.resource.data.message.size() > 0
                    && request.resource.data.message.size() <= 2000;
      allow read, update, delete: if isAdmin();
    }

    // Orders: validated create, admin only for read/update/delete
    match /orders/{orderId} {
      allow create: if request.resource.data.keys().hasAll(['customer', 'items', 'total'])
                    && request.resource.data.customer is map
                    && request.resource.data.customer.keys().hasAll(['name', 'email'])
                    && request.resource.data.customer.name is string
                    && request.resource.data.customer.name.size() > 0
                    && request.resource.data.customer.email is string
                    && request.resource.data.items is list
                    && request.resource.data.items.size() > 0
                    && request.resource.data.total is number
                    && request.resource.data.total > 0;
      allow read, update, delete: if isAdmin();
    }

    // Refunds: validated create, admin manages
    match /refunds/{refundId} {
      allow create: if request.resource.data.keys().hasAll(['orderId', 'reason'])
                    && request.resource.data.orderId is string
                    && request.resource.data.orderId.size() > 0
                    && request.resource.data.reason is string
                    && request.resource.data.reason.size() > 0
                    && request.resource.data.reason.size() <= 1000;
      allow read, update, delete: if isAdmin();
    }

    // Designs: public read, admin write
    match /designs/{designId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // Settings: public read, admin write
    match /settings/{settingId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // Garments: public read, admin write
    match /garments/{garmentId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // Plans: public read (for display), admin write
    match /plans/{planId} {
      allow read: if true;
      allow write: if isAdmin();
    }

    // Stock: public read, admin write, but allow decrement during order creation
    match /stock/{stockId} {
      allow read: if true;
      // Admins can do anything
      allow write: if isAdmin();
      // Allow stock decrement from clients (for order creation)
      // Only allows updating quantity (decrement) and salesStats, not arbitrary writes
      allow update: if request.resource.data.quantity is number
                    && request.resource.data.quantity >= 0
                    && request.resource.data.quantity <= resource.data.quantity
                    && request.resource.data.keys().hasAll(['quantity', 'lastUpdated'])
                    && request.resource.data.salesStats is map;
    }

    // Clients: centralized client/tag management - admin only
    match /clients/{clientId} {
      allow read, write: if isAdmin();
      // Also allow Cloud Functions to write (they run with admin privileges)
    }
  }
}
